#!/usr/bin/env bash
set -euo pipefail

# Check if at least one argument (cargo command) is provided
if [ $# -lt 1 ]; then
    echo "Usage: $0 <cargo-command> [args...]"
    exit 1
fi

CARGO_CMD=$1
shift  # Remove the command from arguments, leaving optional args

# Supported commands
case "$CARGO_CMD" in
    clean|build|test|fmt|clippy)
        ;;
    *)
        echo "Unsupported cargo command: $CARGO_CMD"
        echo "Supported commands: clean, build, test, fmt, clippy"
        exit 1
        ;;
esac

# Detect build mode: release if "--release" is present, otherwise debug
MODE="debug"
for arg in "$@"; do
    if [[ "$arg" == "--release" ]]; then
        MODE="release"
        break
    fi
done

# Enable backtraces only in debug mode
if [[ "$MODE" == "debug" ]]; then
    echo "üêõ Debug mode detected ‚Üí enabling full Rust backtraces"
    export RUST_BACKTRACE=full
    export RUST_LIB_BACKTRACE=1
else
    echo "‚ö° Release mode detected ‚Üí backtraces disabled"
fi

# Find all directories with Cargo.toml, including the root if present
DIRS=$(find . -name Cargo.toml -exec dirname {} \; | sort -u)

for dir in $DIRS; do
    echo "üöÄ Running 'cargo $CARGO_CMD $*' in $dir"
    (
        cd "$dir" || exit 1
        cargo "$CARGO_CMD" "$@"
    )
    echo "‚úÖ Finished 'cargo $CARGO_CMD' in $dir"
done
